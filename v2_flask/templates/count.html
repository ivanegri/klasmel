{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header flex justify-between items-center">
        <h2 class="card-title">Nova Contagem</h2>
        <div class="flex gap-2 items-center">
            <label for="date" class="form-label" style="margin-bottom: 0;">Data:</label>
            <input type="date" id="date" class="form-control" value="{{ today }}" style="width: auto;">
        </div>
    </div>

    <div class="table-container">
        {% for group in groups %}
        <h3 style="margin: 1.5rem 0 1rem 0; color: var(--primary-color);">{{ group }}</h3>
        <table>
            <thead>
                <tr>
                    <th style="width: 30%;">Produto</th>
                    <th>Câmara</th>
                    <th>Freezer 01</th>
                    <th>Freezer 02</th>
                    <th>Total</th>
                    <th>Mínimo</th>
                    <th>Produção</th>
                </tr>
            </thead>
            <tbody>
                {% for item in data %}
                {% if item['Grupo'] == group %}
                <tr class="item-row" data-id="{{ loop.index0 }}">
                    <td>{{ item['Produto'] }}</td>
                    <td>
                        <input type="number" class="form-control count-input" data-field="Câmara"
                            value="{{ item['Câmara'] }}">
                    </td>
                    <td>
                        <input type="number" class="form-control count-input" data-field="Freezer 01"
                            value="{{ item['Freezer 01'] }}">
                    </td>
                    <td>
                        <input type="number" class="form-control count-input" data-field="Freezer 02"
                            value="{{ item['Freezer 02'] }}">
                    </td>
                    <td class="total-cell">{{ item['TOTAL'] }}</td>
                    <td class="min-cell">{{ item['Estoque Minimo'] }}</td>
                    <td class="prod-cell">{{ item['Planejamento de Produção '] }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}
    </div>

    <div style="margin-top: 2rem; text-align: right;">
        <button id="saveBtn" class="btn btn-primary" style="padding: 0.75rem 2rem; font-size: 1.1rem;">
            Salvar Contagem
        </button>
    </div>
</div>

<script>
    const data = {{ data | tojson }};

    // Update calculations on input change
    document.querySelectorAll('.count-input').forEach(input => {
        input.addEventListener('input', updateRow);
    });

    function updateRow(e) {
        const row = e.target.closest('tr');
        const inputs = row.querySelectorAll('.count-input');
        let total = 0;

        inputs.forEach(inp => {
            total += Number(inp.value) || 0;
        });

        // Update UI
        row.querySelector('.total-cell').textContent = total;

        const min = Number(row.querySelector('.min-cell').textContent) || 0;
        const prod = min - total;
        row.querySelector('.prod-cell').textContent = prod; // Can be negative

        // Update data object
        const index = row.dataset.id;
        const field = e.target.dataset.field;
        data[index][field] = Number(e.target.value) || 0;
        data[index]['TOTAL'] = total;
        data[index]['Planejamento de Produção '] = prod;
    }

    document.getElementById('saveBtn').addEventListener('click', async () => {
        const date = document.getElementById('date').value;
        if (!date) {
            alert('Por favor, selecione uma data.');
            return;
        }

        try {
            const response = await fetch('{{ url_for("count") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    date: date,
                    items: data
                })
            });

            const result = await response.json();

            if (result.success) {
                alert(result.message);
                window.location.href = '{{ url_for("index") }}';
            } else {
                alert('Erro: ' + result.message);
            }
        } catch (error) {
            alert('Erro ao salvar: ' + error);
        }
    });
</script>
{% endblock %}